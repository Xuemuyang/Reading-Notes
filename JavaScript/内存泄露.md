# 内存泄露

## 疑问

- [x] 内存泄露是怎样一回事，对应用有什么样的影响
- [x] 什么情况会导致内存泄露
- [x] 避免内存泄露的方式
- [x] 如何检查内存泄露
- [x] weakmap 到底是怎么样一回事情

## 什么是内存泄露

无用的内存还在占用，得不到释放，导致整个系统卡顿，甚至崩溃。

## 内存生命周期

提到了内存生命周期的概念，通常有这样三个周期：

- 分配期 分配所需要的内存
- 使用期 使用分配到的内存
- 释放期 不需要时将其释放和归还

## JavaScript 内存管理机制

像 C 语言这样的底层语言一般有管理内存的接口，`malloc()` 和 `free()`。JavaScript 在创建变量时自动进行了分配内存，并且在不使用他们时“自动”释放。释放的过程称为垃圾回收，“自动”是混乱的根源，让开发者们错误的感觉可以不用关心内存管理。

### 内存分配

JavaScript 定义变量就会自动分配内存。

### 内存使用

使用值的过程实际上就是对内存进行读取和写入操作。

### 内存回收

垃圾内存回收通常称为垃圾回收(Garbage Collection)。

内存泄露通常发生在这一步，虽然能够回收绝大部分垃圾内存，还有部分情况需要开发者手动清理。

内存回收主要有两种方式：

- 引用计数
  - 如果没有引用指向该对象，对象会被垃圾回收机制回收
- 标记清除
  - 当变量进入执行环境(可以理解为作用域)标记为“进入环境”，离开环境标记为“离开环境”，被标记“离开环境”的变量可以回收

## JavaScript 内存泄露的场景

- 意外的全局变量
  - 可以通过 Eslint 规则避免
- 被遗忘的计时器
  - 在合适的生命周期进行销毁
- 被遗忘的事件监听器(既可以是 window 的事件，也可以是 EventBus 一类的)
  - 在合适的生命周期进行销毁
- 被遗忘的闭包
  - 闭包的一个缺点就是内存占用相对高
- 脱离 DOM 的引用
  - 将 DOM 赋给了某个值，但是这个值没有用到
- ES6 的 Set，当成员是引用类型，看一个例子
  - 可以考虑使用 WeakSet
- ES6 的 Map，键名可能是引用类型
  - 可以考虑使用 WeakMap

```js
let map = new Set();
let value = { test: 22};
map.add(value);

value= null;
```

## 如何发现内存泄露

1.确定是否有内存泄露

Performance 工具，勾选 Memory，开始录制，如果内存有递增，说明有问题

2.查找内存泄露的位置

使用 Memory 工具的 snapshot 来看占用的空间，进行一个倒序排序

## 参考

- [JavaScript 内存泄漏教程](http://www.ruanyifeng.com/blog/2017/04/memory-leak.html)
- [深入了解 JavaScript 内存泄露](https://segmentfault.com/a/1190000020231307)
